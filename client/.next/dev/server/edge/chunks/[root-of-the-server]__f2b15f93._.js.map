{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n  const token = request.cookies.get(\"auth_token\")?.value;\n\n  // Registrar presencia del token para depuración\n  console.log(\"Middleware: Token encontrado:\", !!token, { pathname });\n\n  // Verificar token usando /api/auth/profile\n  const verifyToken = async (token: string): Promise<boolean> => {\n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos de espera\n\n      const response = await fetch(\n        `${process.env.NEXT_PUBLIC_API_URL}/auth/profile`,\n        {\n          method: \"GET\",\n          headers: {\n            Authorization: `Bearer ${token}`,\n            \"Content-Type\": \"application/json\",\n          },\n          credentials: \"include\", // Coincidir con la configuración de authApi\n          signal: controller.signal,\n        }\n      );\n\n      clearTimeout(timeoutId);\n      console.log(\"Middleware: Estado de respuesta del perfil:\", response.status);\n      return response.ok;\n    } catch (error) {\n      console.error(\"Middleware: Falló la verificación del token:\", error);\n      // Si es un error de red o tiempo de espera, asumir que el token es válido para evitar redirecciones innecesarias\n      if (\n        error instanceof Error &&\n        (error.name === \"AbortError\" || error.message.includes(\"fetch\"))\n      ) {\n        console.log(\n          \"Middleware: Error de red, permitiendo acceso con token existente\"\n        );\n        return true; // Permitir acceso si hay un problema de red\n      }\n      return false;\n    }\n  };\n\n  // Para la página de éxito, permitir acceso si el token existe (omitir verificación para evitar problemas de redirección de pasarelas de pago)\n  if (pathname === \"/success\") {\n    if (!token) {\n      const signInUrl = new URL(\"/auth/signin\", request.url);\n      return NextResponse.redirect(signInUrl);\n    }\n    // Siempre permitir acceso a la página de éxito si el token existe\n    return NextResponse.next();\n  }\n\n  const isAuthenticated = token ? await verifyToken(token) : false;\n  console.log(\"Middleware: Autenticado:\", isAuthenticated);\n\n  // Proteger rutas /user\n  if (pathname.startsWith(\"/user\")) {\n    if (!isAuthenticated) {\n      console.log(\n        \"Middleware: Redirigiendo usuario no autenticado a /auth/signin\"\n      );\n      const signInUrl = new URL(\"/auth/signin\", request.url);\n      return NextResponse.redirect(signInUrl);\n    }\n  }\n\n  // Restringir rutas /auth para usuarios autenticados\n  if (pathname.startsWith(\"/auth\")) {\n    if (isAuthenticated) {\n      console.log(\"Middleware: Redirigiendo usuario autenticado a /user\");\n      const userUrl = new URL(\"/user/profile\", request.url);\n      return NextResponse.redirect(userUrl);\n    }\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: [\"/user/:path*\", \"/auth/:path*\", \"/success\"],\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;;AAEO,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IACpC,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,eAAe;IAEjD,gDAAgD;IAChD,QAAQ,GAAG,CAAC,iCAAiC,CAAC,CAAC,OAAO;QAAE;IAAS;IAEjE,2CAA2C;IAC3C,MAAM,cAAc,OAAO;QACzB,IAAI;YACF,MAAM,aAAa,IAAI;YACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI,OAAO,uBAAuB;YAErF,MAAM,WAAW,MAAM,MACrB,iEAAmC,aAAa,CAAC,EACjD;gBACE,QAAQ;gBACR,SAAS;oBACP,eAAe,CAAC,OAAO,EAAE,OAAO;oBAChC,gBAAgB;gBAClB;gBACA,aAAa;gBACb,QAAQ,WAAW,MAAM;YAC3B;YAGF,aAAa;YACb,QAAQ,GAAG,CAAC,+CAA+C,SAAS,MAAM;YAC1E,OAAO,SAAS,EAAE;QACpB,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,gDAAgD;YAC9D,iHAAiH;YACjH,IACE,iBAAiB,SACjB,CAAC,MAAM,IAAI,KAAK,gBAAgB,MAAM,OAAO,CAAC,QAAQ,CAAC,QAAQ,GAC/D;gBACA,QAAQ,GAAG,CACT;gBAEF,OAAO,MAAM,4CAA4C;YAC3D;YACA,OAAO;QACT;IACF;IAEA,8IAA8I;IAC9I,IAAI,aAAa,YAAY;QAC3B,IAAI,CAAC,OAAO;YACV,MAAM,YAAY,IAAI,IAAI,gBAAgB,QAAQ,GAAG;YACrD,OAAO,gMAAY,CAAC,QAAQ,CAAC;QAC/B;QACA,kEAAkE;QAClE,OAAO,gMAAY,CAAC,IAAI;IAC1B;IAEA,MAAM,kBAAkB,QAAQ,MAAM,YAAY,SAAS;IAC3D,QAAQ,GAAG,CAAC,4BAA4B;IAExC,uBAAuB;IACvB,IAAI,SAAS,UAAU,CAAC,UAAU;QAChC,IAAI,CAAC,iBAAiB;YACpB,QAAQ,GAAG,CACT;YAEF,MAAM,YAAY,IAAI,IAAI,gBAAgB,QAAQ,GAAG;YACrD,OAAO,gMAAY,CAAC,QAAQ,CAAC;QAC/B;IACF;IAEA,oDAAoD;IACpD,IAAI,SAAS,UAAU,CAAC,UAAU;QAChC,IAAI,iBAAiB;YACnB,QAAQ,GAAG,CAAC;YACZ,MAAM,UAAU,IAAI,IAAI,iBAAiB,QAAQ,GAAG;YACpD,OAAO,gMAAY,CAAC,QAAQ,CAAC;QAC/B;IACF;IAEA,OAAO,gMAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;QAAgB;QAAgB;KAAW;AACvD"}}]
}